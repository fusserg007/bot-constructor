<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–æ–≤ - Bot Constructor</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .stats-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            margin: 0;
        }

        .bot-stats {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .bot-stats h3 {
            margin: 0 0 20px 0;
            color: #333;
        }

        .bot-list {
            display: grid;
            gap: 15px;
        }

        .bot-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .bot-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .bot-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .bot-metrics {
            display: flex;
            gap: 20px;
            text-align: center;
        }

        .metric {
            display: flex;
            flex-direction: column;
        }

        .metric .value {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }

        .metric .label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .period-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .period-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .period-btn:hover {
            background: #f8f9fa;
        }

        .period-btn.active:hover {
            background: #0056b3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background: #28a745;
        }

        .status-inactive {
            background: #dc3545;
        }

        .status-paused {
            background: #ffc107;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .activity-chart {
            height: 200px;
            display: flex;
            align-items: end;
            gap: 2px;
            padding: 10px 0;
        }

        .activity-bar {
            flex: 1;
            background: #007bff;
            min-height: 2px;
            border-radius: 2px 2px 0 0;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .activity-bar:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <h1>ü§ñ Bot Constructor</h1>
            </div>
            <div class="nav-menu">
                <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="dashboard.html">–î–∞—à–±–æ—Ä–¥</a>
                <a href="stats.html" class="active">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
                <a href="#" onclick="logout()">–í—ã—Ö–æ–¥</a>
            </div>
        </nav>

        <div class="stats-container">
            <div class="stats-header">
                <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–æ–≤</h2>
                <div class="period-selector">
                    <button class="period-btn" data-period="24h">24 —á–∞—Å–∞</button>
                    <button class="period-btn" data-period="7d">7 –¥–Ω–µ–π</button>
                    <button class="period-btn active" data-period="30d">30 –¥–Ω–µ–π</button>
                    <button class="period-btn" data-period="90d">90 –¥–Ω–µ–π</button>
                </div>
            </div>

            <div id="loading" class="loading">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
            </div>

            <div id="error" class="error" style="display: none;">
                <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>
            </div>

            <div id="stats-content" style="display: none;">
                <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="stats-cards">
                    <div class="stat-card">
                        <h3>–í—Å–µ–≥–æ –±–æ—Ç–æ–≤</h3>
                        <p class="value" id="total-bots">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö –±–æ—Ç–æ–≤</h3>
                        <p class="value" id="active-bots">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>–°–æ–æ–±—â–µ–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</h3>
                        <p class="value" id="total-messages">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                        <p class="value" id="total-users">0</p>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±–æ—Ç–∞–º -->
                <div class="bot-stats">
                    <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±–æ—Ç–∞–º</h3>
                    <div id="bot-list" class="bot-list">
                        <!-- –°–ø–∏—Å–æ–∫ –±–æ—Ç–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>

                <!-- –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
                <div class="chart-container">
                    <h3>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º</h3>
                    <div id="activity-chart" class="activity-chart">
                        <!-- –ì—Ä–∞—Ñ–∏–∫ –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPeriod = '30d';
        let dashboardStats = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            window.location.href = 'index.html';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞
        async function loadDashboardStats() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/stats/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
                }

                dashboardStats = await response.json();
                displayDashboardStats();
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function displayDashboardStats() {
            if (!dashboardStats) return;

            document.getElementById('total-bots').textContent = dashboardStats.totalBots;
            document.getElementById('active-bots').textContent = dashboardStats.activeBots;
            document.getElementById('total-messages').textContent = dashboardStats.totalMessages.toLocaleString();
            document.getElementById('total-users').textContent = dashboardStats.totalUsers.toLocaleString();

            displayBotList();
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –±–æ—Ç–æ–≤
        function displayBotList() {
            const botList = document.getElementById('bot-list');
            botList.innerHTML = '';

            if (!dashboardStats.bots || dashboardStats.bots.length === 0) {
                botList.innerHTML = '<p>–ù–µ—Ç –±–æ—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
                return;
            }

            dashboardStats.bots.forEach(bot => {
                const botItem = document.createElement('div');
                botItem.className = 'bot-item';
                
                const statusClass = bot.status === 'active' ? 'status-active' : 
                                  bot.status === 'paused' ? 'status-paused' : 'status-inactive';

                botItem.innerHTML = `
                    <div class="bot-info">
                        <h4>
                            <span class="status-indicator ${statusClass}"></span>
                            ${bot.name}
                        </h4>
                        <p>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${bot.lastActivity ? 
                            new Date(bot.lastActivity).toLocaleString() : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</p>
                    </div>
                    <div class="bot-metrics">
                        <div class="metric">
                            <div class="value">${bot.messagesProcessed}</div>
                            <div class="label">–°–æ–æ–±—â–µ–Ω–∏–π</div>
                        </div>
                        <div class="metric">
                            <div class="value">${bot.activeUsers}</div>
                            <div class="label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                        </div>
                        <div class="metric">
                            <div class="value">${bot.errorsCount || 0}</div>
                            <div class="label">–û—à–∏–±–æ–∫</div>
                        </div>
                        <div class="metric">
                            <button onclick="viewBotDetails('${bot.id}')" class="btn btn-sm">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
                        </div>
                    </div>
                `;
                
                botList.appendChild(botItem);
            });
        }

        // –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–æ—Ç–∞
        function viewBotDetails(botId) {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
            alert(`–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –±–æ—Ç–∞ ${botId} –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏`);
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞
        function switchPeriod(period) {
            currentPeriod = period;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');

            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            loadStats();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            showLoading();
            try {
                await loadDashboardStats();
                showContent();
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('stats-content').style.display = 'none';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
        function showContent() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('stats-content').style.display = 'block';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').querySelector('p').textContent = message;
            document.getElementById('stats-content').style.display = 'none';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–∏–æ–¥–∞
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchPeriod(this.dataset.period);
                });
            });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            loadStats();

            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(loadStats, 30000);
        });
    </script>
</body>
</html>