<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –±–æ—Ç–æ–≤ - Bot Constructor</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .deployment-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .deployment-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .bot-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .bot-card:hover {
            transform: translateY(-2px);
        }

        .bot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .bot-info h3 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 20px;
        }

        .bot-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .bot-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-active {
            background: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        }

        .status-paused {
            background: #ffc107;
        }

        .status-draft {
            background: #6c757d;
        }

        .status-error {
            background: #dc3545;
        }

        .bot-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .bot-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .token-form {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .webhook-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .webhook-info h4 {
            margin: 0 0 10px 0;
            color: #155724;
        }

        .webhook-url {
            font-family: monospace;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            word-break: break-all;
        }

        .instructions {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .instructions h4 {
            margin: 0 0 15px 0;
            color: #004085;
        }

        .instructions ol {
            margin: 0;
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .export-content {
            margin-top: 20px;
        }

        .export-content textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <h1>ü§ñ Bot Constructor</h1>
            </div>
            <div class="nav-menu">
                <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="stats.html">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
                <a href="subscription.html">–ü–æ–¥–ø–∏—Å–∫–∏</a>
                <a href="deployment.html" class="active">–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ</a>
                <a href="#" onclick="logout()">–í—ã—Ö–æ–¥</a>
            </div>
        </nav>

        <div class="deployment-container">
            <div class="deployment-header">
                <h2>üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º –±–æ—Ç–æ–≤</h2>
                <p>–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–π—Ç–µ, —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –≤–∞—à–∏—Ö –±–æ—Ç–æ–≤</p>
            </div>

            <div id="loading" class="loading">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –±–æ—Ç–æ–≤...</p>
            </div>

            <div id="error" class="error" style="display: none;">
                <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
            </div>

            <div id="bots-container">
                <!-- –ë–æ—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeExportModal()">&times;</span>
            <h3>üì¶ –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞</h3>
            <div id="export-content" class="export-content">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <script>
        let bots = [];

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            window.location.href = 'index.html';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –±–æ—Ç–æ–≤
        async function loadBots() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/bots', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ—Ç–æ–≤');
                }

                const data = await response.json();
                bots = data.data.bots || [];
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞
                for (let bot of bots) {
                    try {
                        const statusResponse = await fetch(`/api/deployment/status/${bot.id}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (statusResponse.ok) {
                            const statusData = await statusResponse.json();
                            bot.deploymentStatus = statusData.data;
                        }
                    } catch (error) {
                        console.error(`Error loading status for bot ${bot.id}:`, error);
                    }
                }

                displayBots();
            } catch (error) {
                console.error('Error loading bots:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ—Ç–æ–≤');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–æ—Ç–æ–≤
        function displayBots() {
            const container = document.getElementById('bots-container');
            container.innerHTML = '';

            if (bots.length === 0) {
                container.innerHTML = `
                    <div class="bot-card">
                        <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±–æ—Ç–æ–≤. <a href="index.html">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –±–æ—Ç–∞</a></p>
                    </div>
                `;
                return;
            }

            bots.forEach(bot => {
                const botCard = createBotCard(bot);
                container.appendChild(botCard);
            });

            hideLoading();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –±–æ—Ç–∞
        function createBotCard(bot) {
            const card = document.createElement('div');
            card.className = 'bot-card';
            
            const status = bot.deploymentStatus || {};
            const statusClass = getStatusClass(status.status || bot.status);
            const statusText = getStatusText(status.status || bot.status);

            card.innerHTML = `
                <div class="bot-header">
                    <div class="bot-info">
                        <h3>${bot.name}</h3>
                        <p>${bot.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                    </div>
                    <div class="bot-status">
                        <span class="status-indicator ${statusClass}"></span>
                        <span>${statusText}</span>
                    </div>
                </div>

                <div class="bot-details">
                    <div class="detail-item">
                        <div class="detail-label">–¢–æ–∫–µ–Ω</div>
                        <div class="detail-value">${bot.token ? '‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω' : '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Webhook</div>
                        <div class="detail-value">${status.webhookUrl ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">–ë–æ—Ç –≤ Telegram</div>
                        <div class="detail-value">${status.botInfo?.username ? '@' + status.botInfo.username : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">–†–∞–∑–≤–µ—Ä–Ω—É—Ç</div>
                        <div class="detail-value">${status.deployedAt ? new Date(status.deployedAt).toLocaleString() : '–ù–∏–∫–æ–≥–¥–∞'}</div>
                    </div>
                </div>

                ${!bot.token ? createTokenForm(bot.id) : ''}
                ${status.webhookUrl ? createWebhookInfo(status.webhookUrl) : ''}

                <div class="bot-actions">
                    ${createActionButtons(bot, status)}
                </div>
            `;

            return card;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–ª—è –≤–≤–æ–¥–∞ —Ç–æ–∫–µ–Ω–∞
        function createTokenForm(botId) {
            return `
                <div class="token-form">
                    <h4>üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞</h4>
                    <p>–î–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ç–æ–∫–µ–Ω –æ—Ç @BotFather</p>
                    <div class="form-group">
                        <label for="token-${botId}">–¢–æ–∫–µ–Ω –±–æ—Ç–∞:</label>
                        <input type="text" id="token-${botId}" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz" />
                    </div>
                    <button class="btn btn-primary" onclick="saveToken('${botId}')">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω
                    </button>
                </div>
            `;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ webhook
        function createWebhookInfo(webhookUrl) {
            return `
                <div class="webhook-info">
                    <h4>üîó Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω</h4>
                    <div class="webhook-url">${webhookUrl}</div>
                </div>
            `;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
        function createActionButtons(bot, status) {
            const buttons = [];

            if (!bot.token) {
                return '<p class="text-muted">–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞</p>';
            }

            if (status.status === 'active') {
                buttons.push(`<button class="btn btn-warning" onclick="stopBot('${bot.id}')">‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>`);
                buttons.push(`<button class="btn btn-secondary" onclick="restartBot('${bot.id}')">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>`);
            } else {
                buttons.push(`<button class="btn btn-success" onclick="deployBot('${bot.id}')">üöÄ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>`);
            }

            buttons.push(`<button class="btn btn-primary" onclick="showWebhookInfo('${bot.id}')">‚ÑπÔ∏è Webhook</button>`);
            buttons.push(`<button class="btn btn-secondary" onclick="exportBot('${bot.id}')">üì¶ –≠–∫—Å–ø–æ—Ä—Ç</button>`);

            return buttons.join('');
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ —Å—Ç–∞—Ç—É—Å–∞
        function getStatusClass(status) {
            switch (status) {
                case 'active': return 'status-active';
                case 'paused': return 'status-paused';
                case 'draft': return 'status-draft';
                default: return 'status-error';
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
        function getStatusText(status) {
            switch (status) {
                case 'active': return '–ê–∫—Ç–∏–≤–µ–Ω';
                case 'paused': return '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                case 'draft': return '–ß–µ—Ä–Ω–æ–≤–∏–∫';
                default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
        async function saveToken(botId) {
            const tokenInput = document.getElementById(`token-${botId}`);
            const token = tokenInput.value.trim();

            if (!token) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞');
                return;
            }

            try {
                // –°–Ω–∞—á–∞–ª–∞ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω
                const authToken = localStorage.getItem('authToken');
                const validateResponse = await fetch('/api/deployment/validate-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ token })
                });

                const validateData = await validateResponse.json();
                
                if (!validateData.success || !validateData.data.valid) {
                    alert('–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω: ' + (validateData.data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    return;
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ –±–æ—Ç–µ
                const updateResponse = await fetch(`/api/bots/${botId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ token })
                });

                if (updateResponse.ok) {
                    showSuccess('–¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞');
                }

            } catch (error) {
                console.error('Error saving token:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞');
            }
        }

        // –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –±–æ—Ç–∞
        async function deployBot(botId) {
            if (!confirm('–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–æ—Ç–∞? –û–Ω —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ Telegram.')) {
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/deployment/deploy/${botId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(data.message);
                    if (data.data.instructions) {
                        showInstructions(data.data.instructions);
                    }
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    alert('–û—à–∏–±–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è: ' + data.error);
                }
            } catch (error) {
                console.error('Error deploying bot:', error);
                alert('–û—à–∏–±–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –±–æ—Ç–∞');
            }
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞
        async function stopBot(botId) {
            if (!confirm('–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞? –û–Ω –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è.')) {
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/deployment/stop/${botId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(data.message);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: ' + data.error);
                }
            } catch (error) {
                console.error('Error stopping bot:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞');
            }
        }

        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
        async function restartBot(botId) {
            if (!confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞?')) {
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/deployment/restart/${botId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(data.message);
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞: ' + data.error);
                }
            } catch (error) {
                console.error('Error restarting bot:', error);
                alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ webhook
        async function showWebhookInfo(botId) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/deployment/webhook-info/${botId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const info = data.data;
                    alert(`Webhook –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n\nURL: ${info.url}\n–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${info.last_error_date ? new Date(info.last_error_date * 1000).toLocaleString() : '–ù–µ—Ç –æ—à–∏–±–æ–∫'}\n–û–∂–∏–¥–∞—é—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: ${info.pending_update_count}`);
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: ' + data.error);
                }
            } catch (error) {
                console.error('Error getting webhook info:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ webhook');
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –±–æ—Ç–∞
        async function exportBot(botId) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/deployment/export/${botId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showExportModal(data.data);
                } else {
                    alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + data.error);
                }
            } catch (error) {
                console.error('Error exporting bot:', error);
                alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∞
        function showExportModal(exportData) {
            const modal = document.getElementById('export-modal');
            const content = document.getElementById('export-content');

            content.innerHTML = `
                <p>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞ –≥–æ—Ç–æ–≤–∞ –∫ —ç–∫—Å–ø–æ—Ä—Ç—É:</p>
                <div class="form-group">
                    <label>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (JSON):</label>
                    <textarea readonly>${JSON.stringify(exportData.config, null, 2)}</textarea>
                </div>
                <div class="form-group">
                    <label>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é:</label>
                    <textarea readonly>${exportData.instructions}</textarea>
                </div>
                <button class="btn btn-primary" onclick="downloadExport('${exportData.filename}', '${JSON.stringify(exportData.config)}')">
                    üíæ –°–∫–∞—á–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
                </button>
            `;

            modal.style.display = 'block';
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∞
        function closeExportModal() {
            document.getElementById('export-modal').style.display = 'none';
        }

        // –°–∫–∞—á–∞—Ç—å —ç–∫—Å–ø–æ—Ä—Ç
        function downloadExport(filename, configData) {
            const blob = new Blob([configData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            closeExportModal();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        function showInstructions(instructions) {
            const instructionsDiv = document.createElement('div');
            instructionsDiv.className = 'instructions';
            instructionsDiv.innerHTML = `
                <h4>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞</h4>
                <ol>
                    ${instructions.map(instruction => `<li>${instruction}</li>`).join('')}
                </ol>
            `;

            document.querySelector('.deployment-container').appendChild(instructionsDiv);

            setTimeout(() => {
                instructionsDiv.remove();
            }, 10000);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }

        // –°–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.querySelector('p').textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—Ö
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.innerHTML = `<p>${message}</p>`;
            
            document.querySelector('.deployment-container').insertBefore(
                successDiv, 
                document.querySelector('.deployment-container').firstChild
            );
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;

            showLoading();
            loadBots();

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            window.onclick = function(event) {
                const modal = document.getElementById('export-modal');
                if (event.target === modal) {
                    closeExportModal();
                }
            }
        });
    </script>
</body>
</html>