<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç –û—Ç–ª–∞–¥–∫–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        
        .debug-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: calc(100vh - 40px);
        }
        
        .editor-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .debug-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        #editorCanvas {
            width: 100%;
            height: 500px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
            position: relative;
            overflow: auto;
        }
        
        .editor-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #f0f0f0;
        }
        
        .btn.primary {
            background: #1976d2;
            color: white;
            border-color: #1976d2;
        }
        
        .btn.success {
            background: #2e7d32;
            color: white;
            border-color: #2e7d32;
        }
        
        .btn.warning {
            background: #ef6c00;
            color: white;
            border-color: #ef6c00;
        }
        
        .status-bar {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .node-library {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .node-btn {
            padding: 10px;
            border: 2px dashed #ddd;
            background: #f9f9f9;
            border-radius: 6px;
            cursor: grab;
            font-size: 12px;
            text-align: center;
            min-width: 80px;
        }
        
        .node-btn:hover {
            border-color: #1976d2;
            background: #e3f2fd;
        }
        
        .schema-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .schema-info h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 12px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
        }
        
        .log-container {
            height: 200px;
            overflow-y: auto;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ -->
        <div class="editor-section">
            <h2>üé® –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä</h2>
            
            <div class="editor-controls">
                <button class="btn primary" onclick="loadTestSchema()">üìã –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ö–µ–º—É</button>
                <button class="btn" onclick="clearCanvas()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="btn" onclick="validateSchema()">‚úÖ –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn success" onclick="renderSchema()">üîÑ –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å</button>
                <button class="btn warning" onclick="simulateError()">‚ö†Ô∏è –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É</button>
            </div>
            
            <div class="node-library">
                <div class="node-btn" draggable="true" data-node-type="trigger">üöÄ –¢—Ä–∏–≥–≥–µ—Ä</div>
                <div class="node-btn" draggable="true" data-node-type="action">‚ö° –î–µ–π—Å—Ç–≤–∏–µ</div>
                <div class="node-btn" draggable="true" data-node-type="condition">‚ùì –£—Å–ª–æ–≤–∏–µ</div>
                <div class="node-btn" draggable="true" data-node-type="data">üìä –î–∞–Ω–Ω—ã–µ</div>
            </div>
            
            <div id="editorCanvas"></div>
            
            <div class="status-bar">
                <div id="status-text">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
            </div>
        </div>
        
        <!-- –ü–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏ -->
        <div class="debug-section">
            <h3>üîç –ü–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏</h3>
            
            <div class="schema-info">
                <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ö–µ–º–µ</h4>
                <div class="info-grid">
                    <div class="info-item">
                        <span>–£–∑–ª—ã:</span>
                        <span id="nodes-count">0</span>
                    </div>
                    <div class="info-item">
                        <span>–°–≤—è–∑–∏:</span>
                        <span id="connections-count">0</span>
                    </div>
                    <div class="info-item">
                        <span>–û—à–∏–±–∫–∏:</span>
                        <span id="errors-count">0</span>
                    </div>
                    <div class="info-item">
                        <span>–í—Ä–µ–º—è —Ä–µ–Ω–¥–µ—Ä–∞:</span>
                        <span id="render-time">0ms</span>
                    </div>
                </div>
            </div>
            
            <div class="quick-actions">
                <button class="btn" onclick="exportDiagnostics()">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
                <button class="btn" onclick="clearLogs()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
            </div>
            
            <h4>–õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h4>
            <div id="debug-logs" class="log-container"></div>
            
            <h4>–¢–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞ (JSON)</h4>
            <div id="schema-display" class="log-container"></div>
        </div>
    </div>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º—É –æ—Ç–ª–∞–¥–∫–∏ -->
    <script src="js/EditorDebugger.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ -->
    <script src="js/BotConstructorManager.js"></script>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ -->
    <script src="app.js"></script>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        let currentSchema = null;
        let nodeCounter = 0;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        function updateStatus(message) {
            document.getElementById('status-text').textContent = message;
            if (window.editorDebugger) {
                window.editorDebugger.info(`–°—Ç–∞—Ç—É—Å: ${message}`);
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ö–µ–º—É
        function loadTestSchema() {
            if (window.editorDebugger) {
                window.editorDebugger.startTimer('loadSchema');
            }
            updateStatus('–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ö–µ–º—ã...');
            
            const testSchema = {
                nodes: [
                    {
                        id: 'node1',
                        type: 'trigger',
                        title: '–ù–∞—á–∞–ª–æ',
                        x: 100,
                        y: 100,
                        config: { event: 'start' }
                    },
                    {
                        id: 'node2',
                        type: 'action',
                        title: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ',
                        x: 300,
                        y: 100,
                        config: { message: '–ü—Ä–∏–≤–µ—Ç!' }
                    },
                    {
                        id: 'node3',
                        type: 'condition',
                        title: '–ü—Ä–æ–≤–µ—Ä–∫–∞',
                        x: 500,
                        y: 100,
                        config: { condition: 'user.age > 18' }
                    }
                ],
                connections: [
                    { from: 'node1', to: 'node2' },
                    { from: 'node2', to: 'node3' }
                ]
            };
            
            currentSchema = testSchema;
            if (window.editorDebugger) {
                window.editorDebugger.logSchemaLoad(testSchema, true);
            }
            
            // –°–∏–º—É–ª–∏—Ä—É–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
            renderSchema();
            
            if (window.editorDebugger) {
                window.editorDebugger.endTimer('loadSchema');
            }
            updateStatus('–¢–µ—Å—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–º —Å—Ö–µ–º—É
        function renderSchema() {
            if (!currentSchema) {
                if (window.editorDebugger) {
                    window.editorDebugger.warn('–ù–µ—Ç —Å—Ö–µ–º—ã –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞');
                }
                return;
            }
            
            if (window.editorDebugger) {
                window.editorDebugger.startTimer('render');
            }
            updateStatus('–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ö–µ–º—ã...');
            
            const canvas = document.getElementById('editorCanvas');
            canvas.innerHTML = '';
            
            // –†–µ–Ω–¥–µ—Ä–∏–º —É–∑–ª—ã
            currentSchema.nodes.forEach(node => {
                try {
                    const nodeElement = createNodeElement(node);
                    canvas.appendChild(nodeElement);
                    if (window.editorDebugger) {
                        window.editorDebugger.logNodeRender(node.id, node.type, true);
                    }
                } catch (error) {
                    if (window.editorDebugger) {
                        window.editorDebugger.logNodeRender(node.id, node.type, false);
                        window.editorDebugger.error(`–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —É–∑–ª–∞ ${node.id}`, error);
                    }
                }
            });
            
            // –†–µ–Ω–¥–µ—Ä–∏–º —Å–≤—è–∑–∏
            if (currentSchema.connections) {
                currentSchema.connections.forEach(conn => {
                    try {
                        createConnection(conn.from, conn.to);
                        if (window.editorDebugger) {
                            window.editorDebugger.logConnection(conn.from, conn.to, true);
                        }
                    } catch (error) {
                        if (window.editorDebugger) {
                            window.editorDebugger.logConnection(conn.from, conn.to, false);
                            window.editorDebugger.error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏ ${conn.from} ‚Üí ${conn.to}`, error);
                        }
                    }
                });
            }
            
            if (window.editorDebugger) {
                window.editorDebugger.endTimer('render');
            }
            updateStatus(`–°—Ö–µ–º–∞ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–∞: ${currentSchema.nodes.length} —É–∑–ª–æ–≤`);
            updateSchemaDisplay();
        }
        
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–∑–ª–∞
        function createNodeElement(node) {
            const element = document.createElement('div');
            element.id = node.id;
            element.className = `node node-${node.type}`;
            element.style.cssText = `
                position: absolute;
                left: ${node.x}px;
                top: ${node.y}px;
                width: 120px;
                height: 60px;
                background: ${getNodeColor(node.type)};
                border: 2px solid #333;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 12px;
                cursor: move;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            `;
            element.textContent = node.title;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            element.addEventListener('click', () => {
                if (window.editorDebugger) {
                    window.editorDebugger.info(`–ö–ª–∏–∫ –ø–æ —É–∑–ª—É: ${node.id} (${node.type})`);
                }
            });
            
            return element;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç —É–∑–ª–∞ –ø–æ —Ç–∏–ø—É
        function getNodeColor(type) {
            const colors = {
                trigger: '#4caf50',
                action: '#2196f3',
                condition: '#ff9800',
                data: '#9c27b0'
            };
            return colors[type] || '#666';
        }
        
        // –°–æ–∑–¥–∞–µ–º —Å–≤—è–∑—å –º–µ–∂–¥—É —É–∑–ª–∞–º–∏
        function createConnection(fromId, toId) {
            const fromNode = document.getElementById(fromId);
            const toNode = document.getElementById(toId);
            
            if (!fromNode || !toNode) {
                throw new Error(`–£–∑–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã: ${fromId} ‚Üí ${toId}`);
            }
            
            // –ü—Ä–æ—Å—Ç–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–≤—è–∑–∏ (–ª–∏–Ω–∏—è)
            const canvas = document.getElementById('editorCanvas');
            const line = document.createElement('div');
            
            const fromRect = fromNode.getBoundingClientRect();
            const toRect = toNode.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            
            const x1 = fromRect.left - canvasRect.left + fromRect.width;
            const y1 = fromRect.top - canvasRect.top + fromRect.height / 2;
            const x2 = toRect.left - canvasRect.left;
            const y2 = toRect.top - canvasRect.top + toRect.height / 2;
            
            const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
            
            line.style.cssText = `
                position: absolute;
                left: ${x1}px;
                top: ${y1}px;
                width: ${length}px;
                height: 2px;
                background: #333;
                transform-origin: 0 50%;
                transform: rotate(${angle}deg);
                z-index: -1;
            `;
            
            canvas.appendChild(line);
        }
        
        // –û—á–∏—â–∞–µ–º canvas
        function clearCanvas() {
            document.getElementById('editorCanvas').innerHTML = '';
            currentSchema = null;
            if (window.editorDebugger) {
                window.editorDebugger.info('Canvas –æ—á–∏—â–µ–Ω');
            }
            updateStatus('Canvas –æ—á–∏—â–µ–Ω');
            updateSchemaDisplay();
        }
        
        // –í–∞–ª–∏–¥–∏—Ä—É–µ–º —Å—Ö–µ–º—É
        function validateSchema() {
            if (!currentSchema) {
                if (window.editorDebugger) {
                    window.editorDebugger.warn('–ù–µ—Ç —Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏');
                }
                return;
            }
            
            if (window.editorDebugger) {
                window.editorDebugger.info('–ù–∞—á–∞–ª–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—Ö–µ–º—ã');
            }
            
            const issues = [];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–∑–ª—ã
            if (!currentSchema.nodes || currentSchema.nodes.length === 0) {
                issues.push('–°—Ö–µ–º–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —É–∑–ª–æ–≤');
            }
            
            currentSchema.nodes?.forEach(node => {
                if (!node.id) issues.push(`–£–∑–µ–ª –±–µ–∑ ID: ${JSON.stringify(node)}`);
                if (!node.type) issues.push(`–£–∑–µ–ª –±–µ–∑ —Ç–∏–ø–∞: ${node.id}`);
                if (typeof node.x !== 'number') issues.push(`–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è X: ${node.id}`);
                if (typeof node.y !== 'number') issues.push(`–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è Y: ${node.id}`);
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤—è–∑–∏
            currentSchema.connections?.forEach(conn => {
                if (!conn.from) issues.push('–°–≤—è–∑—å –±–µ–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞');
                if (!conn.to) issues.push('–°–≤—è–∑—å –±–µ–∑ —Ü–µ–ª–∏');
                
                const fromExists = currentSchema.nodes.some(n => n.id === conn.from);
                const toExists = currentSchema.nodes.some(n => n.id === conn.to);
                
                if (!fromExists) issues.push(`–°–≤—è–∑—å —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —É–∑–µ–ª: ${conn.from}`);
                if (!toExists) issues.push(`–°–≤—è–∑—å —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —É–∑–µ–ª: ${conn.to}`);
            });
            
            if (issues.length === 0) {
                if (window.editorDebugger) {
                    window.editorDebugger.success('–°—Ö–µ–º–∞ –≤–∞–ª–∏–¥–Ω–∞');
                }
                updateStatus('–°—Ö–µ–º–∞ –≤–∞–ª–∏–¥–Ω–∞ ‚úÖ');
            } else {
                issues.forEach(issue => {
                    if (window.editorDebugger) {
                        window.editorDebugger.error(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: ${issue}`);
                    }
                });
                updateStatus(`–ù–∞–π–¥–µ–Ω–æ ${issues.length} –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ‚ùå`);
            }
        }
        
        // –°–∏–º—É–ª–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
        function simulateError() {
            if (window.editorDebugger) {
                window.editorDebugger.error('–°–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', {
                    type: 'test_error',
                    timestamp: Date.now()
                });
            }
            updateStatus('–û—à–∏–±–∫–∞ —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–∞');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ö–µ–º—ã
        function updateSchemaDisplay() {
            const display = document.getElementById('schema-display');
            if (display) {
                display.textContent = currentSchema ? 
                    JSON.stringify(currentSchema, null, 2) : 
                    '–°—Ö–µ–º–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞';
            }
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
        function exportDiagnostics() {
            if (window.editorDebugger) {
                window.editorDebugger.export();
            }
        }
        
        // –û—á–∏—â–∞–µ–º –ª–æ–≥–∏
        function clearLogs() {
            if (window.editorDebugger) {
                window.editorDebugger.clear();
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            if (window.editorDebugger) {
                window.editorDebugger.success('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–ª–∞–¥–∫–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            }
            updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ö–µ–º—É
            setTimeout(() => {
                loadTestSchema();
            }, 1000);
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        setInterval(() => {
            if (window.editorDebugger) {
                const stats = window.editorDebugger.stats;
                document.getElementById('nodes-count').textContent = stats.nodesRendered;
                document.getElementById('connections-count').textContent = stats.connectionsCreated;
                document.getElementById('errors-count').textContent = stats.errorsCount;
                document.getElementById('render-time').textContent = `${stats.renderTime.toFixed(1)}ms`;
            }
        }, 1000);
    </script>
</body>
</html>