<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ Frontend</title>
    <link rel="stylesheet" href="/css/performance.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.danger:hover {
            background: #c82333;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .performance-test {
            margin: 20px 0;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 6px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ Frontend</h1>
        <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–¥–∞—á–µ 12.1</p>

        <div class="performance-test">
            <h2>‚ö° –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h2>
            <button class="btn" onclick="testAPICache()">–¢–µ—Å—Ç API –∫—ç—à–∞</button>
            <button class="btn" onclick="testMultipleRequests()">–¢–µ—Å—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</button>
            <button class="btn" onclick="loadPerformanceStats()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
            <button class="btn danger" onclick="clearCache()">–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</button>
        </div>

        <div class="stats-grid" id="statsGrid">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>

        <div class="log" id="log">
            <strong>–õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π:</strong><br>
            –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é...<br>
        </div>
    </div>

    <script>
        let requestCount = 0;
        
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        async function testAPICache() {
            log('üîç –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç API –∫—ç—à–∞...');
            const startTime = performance.now();
            
            try {
                // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å MISS
                const response1 = await fetch('/api/health');
                const data1 = await response1.json();
                const cacheStatus1 = response1.headers.get('X-Cache') || 'NO-CACHE';
                log(`–ó–∞–ø—Ä–æ—Å 1: ${cacheStatus1} (${response1.headers.get('X-Response-Time')})`);
                
                // –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å HIT
                const response2 = await fetch('/api/health');
                const data2 = await response2.json();
                const cacheStatus2 = response2.headers.get('X-Cache') || 'NO-CACHE';
                log(`–ó–∞–ø—Ä–æ—Å 2: ${cacheStatus2} (${response2.headers.get('X-Response-Time')})`);
                
                const endTime = performance.now();
                log(`‚úÖ –¢–µ—Å—Ç API –∫—ç—à–∞ –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞ ${(endTime - startTime).toFixed(2)}ms`);
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ API –∫—ç—à–∞: ${error.message}`);
            }
        }

        async function testMultipleRequests() {
            log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤...');
            const startTime = performance.now();
            const requests = 10;
            
            try {
                const promises = [];
                for (let i = 0; i < requests; i++) {
                    promises.push(fetch('/api/health'));
                }
                
                const responses = await Promise.all(promises);
                let hits = 0;
                let misses = 0;
                
                responses.forEach((response, index) => {
                    const cacheStatus = response.headers.get('X-Cache');
                    if (cacheStatus === 'HIT') hits++;
                    if (cacheStatus === 'MISS') misses++;
                });
                
                const endTime = performance.now();
                log(`‚úÖ ${requests} –∑–∞–ø—Ä–æ—Å–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞ ${(endTime - startTime).toFixed(2)}ms`);
                log(`üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: ${hits} HIT, ${misses} MISS`);
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: ${error.message}`);
            }
        }

        async function loadPerformanceStats() {
            log('üìä –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...');
            
            try {
                const response = await fetch('/api/performance/stats');
                const result = await response.json();
                
                if (result.success) {
                    displayStats(result.data);
                    log('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${result.error}`);
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${error.message}`);
            }
        }

        async function clearCache() {
            log('üßπ –û—á–∏—â–∞–µ–º –∫—ç—à...');
            
            try {
                const response = await fetch('/api/performance/cache/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type: 'all' })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ ${result.message}`);
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞: ${result.error}`);
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ—á–∏—Å—Ç–∫–∏: ${error.message}`);
            }
        }

        function displayStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>üéØ API –ö—ç—à</h3>
                    <div class="stat-value">${stats.cache.api.hitRate}%</div>
                    <small>Hit Rate (${stats.cache.api.hits} hits, ${stats.cache.api.misses} misses)</small>
                </div>
                
                <div class="stat-card">
                    <h3>üíæ –†–∞–∑–º–µ—Ä API –∫—ç—à–∞</h3>
                    <div class="stat-value">${stats.cache.api.size}</div>
                    <small>—ç–ª–µ–º–µ–Ω—Ç–æ–≤ (${stats.cache.api.sizeInfo?.kbApprox || 0} KB)</small>
                </div>
                
                <div class="stat-card">
                    <h3>üîß –û–±—â–∏–π –∫—ç—à</h3>
                    <div class="stat-value">${stats.cache.general.hitRate}%</div>
                    <small>Hit Rate (${stats.cache.general.size} —ç–ª–µ–º–µ–Ω—Ç–æ–≤)</small>
                </div>
                
                <div class="stat-card">
                    <h3>‚è±Ô∏è –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</h3>
                    <div class="stat-value">${Math.floor(stats.system.uptime / 60)}</div>
                    <small>–º–∏–Ω—É—Ç</small>
                </div>
                
                <div class="stat-card">
                    <h3>üß† –ü–∞–º—è—Ç—å</h3>
                    <div class="stat-value">${Math.round(stats.system.memory.heapUsed / 1024 / 1024)}</div>
                    <small>MB –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è</small>
                </div>
                
                <div class="stat-card">
                    <h3>üìà –ó–∞–ø—Ä–æ—Å—ã</h3>
                    <div class="stat-value">${Object.keys(stats.requests).length}</div>
                    <small>—É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤</small>
                </div>
            `;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            log('üåê –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≥–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é');
            loadPerformanceStats();
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            loadPerformanceStats();
        }, 10000);
    </script>
</body>
</html>