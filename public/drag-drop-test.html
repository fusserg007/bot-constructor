<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Drag & Drop - Bot Constructor</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-container {
            display: flex;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }
        
        .test-left-panel {
            width: 300px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
        }
        
        .test-canvas-area {
            flex: 1;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            position: relative;
        }
        
        .test-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }
        
        .drag-feedback {
            position: fixed;
            background: rgba(0, 123, 255, 0.1);
            border: 2px dashed #007bff;
            border-radius: 4px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }
        
        .test-log {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 300px;
            height: 200px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            overflow-y: auto;
        }
        
        .node-item {
            transition: transform 0.2s ease;
        }
        
        .node-item:hover {
            transform: translateX(5px);
        }
        
        .node-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-left-panel">
            <h3>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–∑–ª–æ–≤</h3>
            <div id="nodeLibraryContainer"></div>
        </div>
        
        <div class="test-canvas-area">
            <canvas id="visualCanvas" class="test-canvas"></canvas>
            <div class="drag-feedback" id="dragFeedback"></div>
        </div>
    </div>
    
    <div class="test-log" id="testLog">
        <div><strong>–õ–æ–≥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Drag & Drop:</strong></div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–∫—Ä–∏–ø—Ç—ã -->
    <script src="js/NodeLibrary.js"></script>
    <script src="js/BaseNode.js"></script>
    <script src="js/ActionNodes.js"></script>
    <script src="js/NodeRegistry.js"></script>
    <script src="js/VisualEditor.js"></script>
    <script src="js/NodeLibraryPanel.js"></script>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function log(message) {
            const logElement = document.getElementById('testLog');
            const time = new Date().toLocaleTimeString();
            logElement.innerHTML += `<div>[${time}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[DRAG-DROP-TEST] ${message}`);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        let nodeLibrary, visualEditor, nodeLibraryPanel;

        function initTest() {
            try {
                log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–∞ drag & drop...');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É —É–∑–ª–æ–≤
                nodeLibrary = new NodeLibrary();
                nodeLibrary.init();
                log(`‚úÖ NodeLibrary –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (${nodeLibrary.getAllNodes().length} —É–∑–ª–æ–≤)`);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º canvas
                const canvas = document.getElementById('visualCanvas');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
                visualEditor = new VisualEditor(canvas, nodeLibrary, {
                    autoSave: false,
                    serverSync: false,
                    validation: false
                });
                log('‚úÖ VisualEditor –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
                const libraryContainer = document.getElementById('nodeLibraryContainer');
                nodeLibraryPanel = new NodeLibraryPanel(libraryContainer, nodeLibrary);
                nodeLibraryPanel.visualEditor = visualEditor;
                log('‚úÖ NodeLibraryPanel –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                setupTestHandlers();
                
                log('üéØ –¢–µ—Å—Ç –≥–æ—Ç–æ–≤! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç—å —É–∑–µ–ª –Ω–∞ canvas');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`);
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞:', error);
            }
        }

        function setupTestHandlers() {
            const canvas = document.getElementById('visualCanvas');
            const dragFeedback = document.getElementById('dragFeedback');
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
            canvas.addEventListener('dragenter', (e) => {
                e.preventDefault();
                log('üì• Drag enter –Ω–∞ canvas');
                dragFeedback.style.display = 'block';
            });
            
            canvas.addEventListener('dragleave', (e) => {
                e.preventDefault();
                log('üì§ Drag leave —Å canvas');
                dragFeedback.style.display = 'none';
            });
            
            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                dragFeedback.style.left = (e.clientX - 50) + 'px';
                dragFeedback.style.top = (e.clientY - 25) + 'px';
                dragFeedback.style.width = '100px';
                dragFeedback.style.height = '50px';
            });
            
            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                const nodeType = e.dataTransfer.getData('text/plain');
                log(`üéØ Drop –Ω–∞ canvas: ${nodeType}`);
                dragFeedback.style.display = 'none';
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ canvas
            window.addEventListener('resize', () => {
                const canvas = document.getElementById('visualCanvas');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                if (visualEditor) {
                    visualEditor.viewport.width = canvas.width;
                    visualEditor.viewport.height = canvas.height;
                    visualEditor.render();
                }
            });
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', initTest);
    </script>
</body>
</html>