<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ö–µ–º - Bot Constructor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            display: flex;
            gap: 20px;
            height: 80vh;
        }
        
        .test-left {
            width: 350px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
        }
        
        .test-right {
            flex: 1;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            position: relative;
        }
        
        .test-canvas {
            width: 100%;
            height: 100%;
            background: #fafafa;
        }
        
        .test-controls {
            margin-bottom: 20px;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn.success {
            background: #28a745;
        }
        
        .btn.danger {
            background: #dc3545;
        }
        
        .btn.warning {
            background: #ffc107;
            color: #212529;
        }
        
        .test-log {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 300px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .status {
            background: #f0f0f0;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .error {
            color: #f44336;
        }
        
        .success {
            color: #4caf50;
        }
        
        .warning {
            color: #ff9800;
        }
        
        .schema-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .file-input {
            margin: 10px 0;
        }
        
        .schema-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .schema-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .schema-item:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>üîß –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ö–µ–º</h1>
    
    <div class="status" id="status">
        <div>üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    </div>
    
    <div class="test-container">
        <div class="test-left">
            <div class="test-controls">
                <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º–∞–º–∏</h3>
                
                <button class="btn" onclick="createTestSchema()">
                    üìù –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ö–µ–º—É
                </button>
                
                <button class="btn success" onclick="saveSchemaLocal()">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
                </button>
                
                <button class="btn" onclick="loadSchemaLocal()">
                    üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
                </button>
                
                <hr>
                
                <button class="btn success" onclick="saveSchemaServer()">
                    üåê –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                </button>
                
                <button class="btn" onclick="loadSchemaServer()">
                    üåê –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞
                </button>
                
                <hr>
                
                <button class="btn warning" onclick="exportSchemaFile()">
                    üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ —Ñ–∞–π–ª
                </button>
                
                <div class="file-input">
                    <input type="file" id="fileInput" accept=".json" onchange="importSchemaFile(this)">
                    <label for="fileInput">üì• –ò–º–ø–æ—Ä—Ç –∏–∑ —Ñ–∞–π–ª–∞</label>
                </div>
                
                <hr>
                
                <button class="btn" onclick="loadSchemaList()">
                    üìã –°–ø–∏—Å–æ–∫ —Å—Ö–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                </button>
                
                <button class="btn danger" onclick="clearSchema()">
                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Å—Ö–µ–º—É
                </button>
            </div>
            
            <div class="schema-info" id="schemaInfo">
                <strong>–¢–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞:</strong><br>
                –£–∑–ª–æ–≤: 0<br>
                –°–æ–µ–¥–∏–Ω–µ–Ω–∏–π: 0<br>
                ID: –Ω–µ –∑–∞–¥–∞–Ω
            </div>
            
            <div class="schema-list" id="schemaList">
                <div>–°–ø–∏—Å–æ–∫ —Å—Ö–µ–º –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω...</div>
            </div>
        </div>
        
        <div class="test-right">
            <canvas id="testCanvas" class="test-canvas"></canvas>
        </div>
    </div>
    
    <div class="test-log" id="testLog">
        <div><strong>üîç –õ–æ–≥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</strong></div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã -->
    <script src="js/NodeLibrary.js"></script>
    <script src="js/BaseNode.js"></script>
    <script src="js/ActionNodes.js"></script>
    <script src="js/NodeRegistry.js"></script>
    <script src="js/VisualEditor.js"></script>
    <script src="js/NodeLibraryPanel.js"></script>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function testLog(message, type = 'info') {
            const logElement = document.getElementById('testLog');
            const time = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logElement.innerHTML += `<div>[${time}] ${icon} ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[SCHEMA-TEST] ${message}`);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            statusElement.innerHTML = `<div class="${className}">${message}</div>`;
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ö–µ–º–µ
        function updateSchemaInfo() {
            if (!visualEditor) return;
            
            const info = document.getElementById('schemaInfo');
            const nodeCount = visualEditor.nodes.size;
            const connectionCount = visualEditor.connections.size;
            const schemaId = visualEditor.schema ? visualEditor.schema.id : '–Ω–µ –∑–∞–¥–∞–Ω';
            
            info.innerHTML = `
                <strong>–¢–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞:</strong><br>
                –£–∑–ª–æ–≤: ${nodeCount}<br>
                –°–æ–µ–¥–∏–Ω–µ–Ω–∏–π: ${connectionCount}<br>
                ID: ${schemaId}
            `;
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let nodeLibrary, visualEditor;
        let currentSchemaId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            try {
                testLog('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Å—Ö–µ–º...');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É —É–∑–ª–æ–≤
                nodeLibrary = new NodeLibrary();
                nodeLibrary.init();
                testLog(`‚úÖ NodeLibrary –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (${nodeLibrary.getAllNodes().length} —É–∑–ª–æ–≤)`, 'success');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º canvas
                const canvas = document.getElementById('testCanvas');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
                visualEditor = new VisualEditor(canvas, nodeLibrary, {
                    autoSave: false,
                    serverSync: true,
                    validation: false,
                    schema: { id: null, name: 'Test Schema' }
                });
                
                testLog('‚úÖ VisualEditor –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                updateStatus('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Å—Ö–µ–º', 'success');
                updateSchemaInfo();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ö–µ–º
                loadSchemaList();
                
            } catch (error) {
                testLog(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã', 'error');
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ö–µ–º—ã
        function createTestSchema() {
            if (!visualEditor) return;
            
            testLog('üìù –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ö–µ–º—ã...');
            
            try {
                // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ö–µ–º—É
                visualEditor.clearSchema();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö —É–∑–ª–æ–≤
                const node1 = visualEditor.addNodeFromLibrary('command', 100, 100);
                const node2 = visualEditor.addNodeFromLibrary('message', 300, 100);
                const node3 = visualEditor.addNodeFromLibrary('condition', 200, 250);
                
                if (node1 && node2) {
                    // –°–æ–∑–¥–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–µ–∂–¥—É —É–∑–ª–∞–º–∏
                    visualEditor.connectNodes(node1, 'output', node2, 'input');
                }
                
                if (node2 && node3) {
                    visualEditor.connectNodes(node2, 'output', node3, 'input');
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID —Å—Ö–µ–º—ã
                currentSchemaId = 'test_schema_' + Date.now();
                visualEditor.schema = { 
                    id: currentSchemaId, 
                    name: 'Test Schema ' + new Date().toLocaleTimeString() 
                };
                
                updateSchemaInfo();
                testLog(`‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ —Å–æ–∑–¥–∞–Ω–∞ (ID: ${currentSchemaId})`, 'success');
                
            } catch (error) {
                testLog(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ö–µ–º—ã: ${error.message}`, 'error');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ª–æ–∫–∞–ª—å–Ω–æ
        function saveSchemaLocal() {
            if (!visualEditor) return;
            
            testLog('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã –≤ localStorage...');
            
            try {
                const schemaJson = visualEditor.saveSchema();
                const key = `test_schema_${currentSchemaId || 'default'}`;
                
                localStorage.setItem(key, schemaJson);
                testLog(`‚úÖ –°—Ö–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ (–∫–ª—é—á: ${key})`, 'success');
                
            } catch (error) {
                testLog(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ö–µ–º—ã –ª–æ–∫–∞–ª—å–Ω–æ
        function loadSchemaLocal() {
            if (!visualEditor) return;
            
            testLog('üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ö–µ–º—ã –∏–∑ localStorage...');
            
            try {
                const key = `test_schema_${currentSchemaId || 'default'}`;
                const schemaJson = localStorage.getItem(key);
                
                if (schemaJson) {
                    const success = visualEditor.loadSchema(schemaJson);
                    if (success) {
                        updateSchemaInfo();
                        testLog(`‚úÖ –°—Ö–µ–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ (–∫–ª—é—á: ${key})`, 'success');
                    } else {
                        testLog(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ö–µ–º—ã`, 'error');
                    }
                } else {
                    testLog(`‚ö†Ô∏è –°—Ö–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ localStorage (–∫–ª—é—á: ${key})`, 'warning');
                }
                
            } catch (error) {
                testLog(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, 'error');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function saveSchemaServer() {
            if (!visualEditor || !currentSchemaId) {
                testLog('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ö–µ–º—É', 'warning');
                return;
            }
            
            testLog('üåê –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
            
            try {
                const schemaData = visualEditor.serializeSchema();
                schemaData.id = currentSchemaId;
                schemaData.name = visualEditor.schema.name;
                
                const response = await fetch(`/api/visual-schemas/${currentSchemaId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(schemaData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    testLog(`‚úÖ –°—Ö–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (ID: ${result.id})`, 'success');
                    loadSchemaList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    const error = await response.text();
                    testLog(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä: ${error}`, 'error');
                }
                
            } catch (error) {
                testLog(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä: ${error.message}`, 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ö–µ–º—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadSchemaServer() {
            if (!visualEditor || !currentSchemaId) {
                testLog('‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ ID —Å—Ö–µ–º—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏', 'warning');
                return;
            }
            
            testLog('üåê –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ö–µ–º—ã —Å —Å–µ—Ä–≤–µ—Ä–∞...');
            
            try {
                const response = await fetch(`/api/visual-schemas/${currentSchemaId}`);
                
                if (response.ok) {
                    const schemaData = await response.json();
                    const success = visualEditor.loadSchema(schemaData);
                    
                    if (success) {
                        updateSchemaInfo();
                        testLog(`‚úÖ –°—Ö–µ–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ (ID: ${currentSchemaId})`, 'success');
                    } else {
                        testLog(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ö–µ–º—ã —Å —Å–µ—Ä–≤–µ—Ä–∞`, 'error');
                    }
                } else {
                    const error = await response.text();
                    testLog(`‚ùå –°—Ö–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: ${error}`, 'error');
                }
                
            } catch (error) {
                testLog(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞: ${error.message}`, 'error');
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç —Å—Ö–µ–º—ã –≤ —Ñ–∞–π–ª
        function exportSchemaFile() {
            if (!visualEditor) return;
            
            testLog('üì§ –≠–∫—Å–ø–æ—Ä—Ç —Å—Ö–µ–º—ã –≤ —Ñ–∞–π–ª...');
            
            try {
                const filename = `schema_${currentSchemaId || 'export'}_${Date.now()}.json`;
                visualEditor.exportSchemaToFile(filename);
                testLog(`‚úÖ –°—Ö–µ–º–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ —Ñ–∞–π–ª: ${filename}`, 'success');
                
            } catch (error) {
                testLog(`‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
            }
        }

        // –ò–º–ø–æ—Ä—Ç —Å—Ö–µ–º—ã –∏–∑ —Ñ–∞–π–ª–∞
        function importSchemaFile(input) {
            if (!visualEditor || !input.files[0]) return;
            
            const file = input.files[0];
            testLog(`üì• –ò–º–ø–æ—Ä—Ç —Å—Ö–µ–º—ã –∏–∑ —Ñ–∞–π–ª–∞: ${file.name}...`);
            
            visualEditor.importSchemaFromFile(file).then(success => {
                if (success) {
                    updateSchemaInfo();
                    testLog(`‚úÖ –°—Ö–µ–º–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑ —Ñ–∞–π–ª–∞: ${file.name}`, 'success');
                } else {
                    testLog(`‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —Ñ–∞–π–ª–∞: ${file.name}`, 'error');
                }
            }).catch(error => {
                testLog(`‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ö–µ–º
        async function loadSchemaList() {
            testLog('üìã –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ö–µ–º...');
            
            try {
                const response = await fetch('/api/visual-schemas');
                
                if (response.ok) {
                    const schemas = await response.json();
                    const listElement = document.getElementById('schemaList');
                    
                    if (schemas.length === 0) {
                        listElement.innerHTML = '<div>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å—Ö–µ–º</div>';
                    } else {
                        listElement.innerHTML = schemas.map(schema => `
                            <div class="schema-item" onclick="loadSchemaById('${schema.id}')">
                                <strong>${schema.name}</strong><br>
                                <small>ID: ${schema.id}</small><br>
                                <small>–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(schema.updatedAt).toLocaleString()}</small>
                            </div>
                        `).join('');
                    }
                    
                    testLog(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å—Ö–µ–º: ${schemas.length}`, 'success');
                    
                } else {
                    testLog(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å—Ö–µ–º`, 'error');
                }
                
            } catch (error) {
                testLog(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞: ${error.message}`, 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ö–µ–º—ã –ø–æ ID
        async function loadSchemaById(schemaId) {
            currentSchemaId = schemaId;
            testLog(`üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ö–µ–º—ã ID: ${schemaId}...`);
            await loadSchemaServer();
        }

        // –û—á–∏—Å—Ç–∫–∞ —Å—Ö–µ–º—ã
        function clearSchema() {
            if (!visualEditor) return;
            
            testLog('üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ —Å—Ö–µ–º—ã...');
            visualEditor.clearSchema();
            currentSchemaId = null;
            updateSchemaInfo();
            testLog('‚úÖ –°—Ö–µ–º–∞ –æ—á–∏—â–µ–Ω–∞', 'success');
        }

        // –ó–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        document.addEventListener('DOMContentLoaded', init);
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        window.addEventListener('error', (e) => {
            testLog(`üí• JavaScript –æ—à–∏–±–∫–∞: ${e.message}`, 'error');
        });
    </script>
</body>
</html>