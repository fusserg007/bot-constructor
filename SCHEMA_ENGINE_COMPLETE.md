# Schema Engine - Движок выполнения схем ✅ ЗАВЕРШЕНО

## Обзор

Успешно создан и протестирован **Schema Engine** - движок выполнения схем для мультиплатформенного конструктора ботов. Движок интегрирован с системой управления ботами через **BotRuntimeManager**.

## Реализованные компоненты

### 1. SchemaEngine (`src/core/engine/SchemaEngine.ts`)
- ⚙️ **Интерпретация визуальных схем** - поддержка React Flow формата
- 🔄 **Выполнение всех типов узлов**:
  - **Триггеры**: команды, сообщения, callback'и
  - **Действия**: отправка сообщений, медиа, редактирование
  - **Условия**: проверка текста, пользователей, переменных
  - **Данные**: работа с переменными и сессиями
  - **Интеграции**: HTTP запросы, webhook'и
  - **Сценарии**: комплексные действия
- 🔀 **Условная логика** с true/false ветвлением
- 💾 **Управление переменными** и данными сессии
- 📝 **Система шаблонов** с подстановкой переменных `{{variableName}}`
- 🛡️ **Защита от бесконечных циклов** (лимит 100 итераций)
- 📊 **Статистика и мониторинг** выполнения
- ⚡ **Асинхронное выполнение** с изоляцией ошибок

### 2. BotRuntimeManager (`src/core/runtime/BotRuntimeManager.ts`)
- 🤖 **Управление жизненным циклом ботов** (запуск/остановка/перезапуск)
- 🔗 **Интеграция с адаптерами мессенджеров**
- 📨 **Автоматическая обработка** входящих сообщений и callback'ов
- 💾 **Управление сессиями пользователей**
- 📊 **Мониторинг статуса** и статистики ботов
- 🔄 **Горячая перезагрузка схем** без остановки бота
- 🛡️ **Изоляция ошибок** между ботами
- 📡 **Поддержка polling и webhook** режимов

## Результаты тестирования

### Schema Engine Tests ✅
```
✅ Создание движка: ПРОЙДЕН
✅ Простая схема: ПРОЙДЕН  
✅ Условная схема: ПРОЙДЕН
✅ Операции с данными: ПРОЙДЕН
✅ Статистика движка: ПРОЙДЕН
```

### BotRuntimeManager Tests ✅
```
✅ Базовый функционал: ПРОЙДЕН
✅ Перезапуск бота: ПРОЙДЕН
```

## Ключевые возможности

### Поддерживаемые типы узлов

#### Триггеры
- `trigger-command` - обработка команд (/start, /help)
- `trigger-message` - обработка текстовых сообщений
- `trigger-callback` - обработка inline кнопок

#### Действия  
- `action-send-message` - отправка текстовых сообщений
- `action-send-photo` - отправка изображений
- `action-send-video` - отправка видео
- `action-edit-message` - редактирование сообщений
- `action-delete-message` - удаление сообщений

#### Условия
- `condition-text-contains` - проверка содержимого текста
- `condition-text-equals` - точное сравнение текста
- `condition-user-role` - проверка роли пользователя
- `condition-variable` - проверка переменных

#### Данные
- `data-variable-set` - установка переменной
- `data-variable-get` - получение переменной
- `data-save` - сохранение в сессию
- `data-load` - загрузка из сессии

#### Интеграции
- `integration-http` - HTTP запросы к внешним API

#### Сценарии
- `scenario-welcome` - приветствие пользователя
- `scenario-support` - обращение в поддержку

### Система шаблонов

Поддержка подстановки переменных в формате `{{variableName}}`:
```javascript
// Пример: "Привет, {{userName}}! Ваш ID: {{userId}}"
// Результат: "Привет, Иван! Ваш ID: 123456"
```

### Управление состоянием

- **Переменные** - временные данные в рамках выполнения схемы
- **Данные сессии** - постоянные данные пользователя между сессиями
- **Контекст выполнения** - информация о сообщении, пользователе, платформе

## Архитектура интеграции

```
┌─────────────────────────────────────────────────────────────┐
│                    BotRuntimeManager                        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  Bot Lifecycle  │  │  Schema Engine  │  │  User Sessions  │ │
│  │  Management     │  │  Integration    │  │  Management     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    SchemaEngine                             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  Node Execution │  │  Flow Control   │  │  Error Handling │ │
│  │  Engine         │  │  & Validation   │  │  & Monitoring   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                 Messenger Adapters                          │
│     Telegram    │      MAX      │    WhatsApp    │ Discord  │
└─────────────────────────────────────────────────────────────┘
```

## Примеры использования

### Простая схема: команда → ответ
```javascript
const nodes = [
  {
    id: 'trigger-1',
    type: 'trigger-command',
    data: { command: '/start' }
  },
  {
    id: 'action-1', 
    type: 'action-send-message',
    data: { message: 'Привет, {{userName}}!' }
  }
];

const edges = [
  { source: 'trigger-1', target: 'action-1' }
];
```

### Условная схема: проверка → разные ответы
```javascript
const nodes = [
  {
    id: 'trigger-1',
    type: 'trigger-message'
  },
  {
    id: 'condition-1',
    type: 'condition-text-contains',
    data: { pattern: 'привет' }
  },
  {
    id: 'action-true',
    type: 'action-send-message', 
    data: { message: 'Привет! Как дела?' }
  },
  {
    id: 'action-false',
    type: 'action-send-message',
    data: { message: 'Не понял, что вы имеете в виду.' }
  }
];

const edges = [
  { source: 'trigger-1', target: 'condition-1' },
  { source: 'condition-1', target: 'action-true', sourceHandle: 'true' },
  { source: 'condition-1', target: 'action-false', sourceHandle: 'false' }
];
```

## Следующие шаги

Задача 6.1 "Создать движок выполнения схем" **ЗАВЕРШЕНА** ✅

Следующие задачи для реализации:
- 6.2 Реализовать основные типы узлов
- 6.3 Добавить поддержку интеграций
- 7.1 Создать библиотеку готовых шаблонов
- 8.1 Создать главную панель управления

## Файлы проекта

### Основные компоненты
- `src/core/engine/SchemaEngine.ts` - движок выполнения схем
- `src/core/runtime/BotRuntimeManager.ts` - менеджер выполнения ботов
- `src/core/adapters/MessengerAdapter.ts` - базовый адаптер мессенджеров
- `src/core/adapters/AdapterRegistry.ts` - реестр адаптеров
- `src/core/types/index.ts` - типы данных

### Тесты
- `src/test-schema-engine.ts` - тесты движка схем
- `src/test-bot-runtime.ts` - тесты менеджера ботов

---

**Статус**: ✅ ЗАВЕРШЕНО  
**Дата**: 25.07.2025  
**Автор**: Kiro AI Assistant