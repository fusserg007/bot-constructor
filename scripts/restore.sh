#!/bin/bash

# ะกะบัะธะฟั ะฒะพัััะฐะฝะพะฒะปะตะฝะธั ะดะฐะฝะฝัั Bot Constructor
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./scripts/restore.sh <backup_file>

set -e

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# ะัะพะฒะตัะบะฐ ะฐัะณัะผะตะฝัะพะฒ
if [[ $# -eq 0 ]]; then
    error "ะฃะบะฐะถะธัะต ัะฐะนะป ะฑัะบะฐะฟะฐ ะดะปั ะฒะพัััะฐะฝะพะฒะปะตะฝะธั"
    echo "ะัะฟะพะปัะทะพะฒะฐะฝะธะต: $0 <backup_file>"
    echo ""
    echo "ะะพัััะฟะฝัะต ะฑัะบะฐะฟั:"
    ls -la backups/*.tar.gz 2>/dev/null || echo "ะัะบะฐะฟั ะฝะต ะฝะฐะนะดะตะฝั"
    exit 1
fi

BACKUP_FILE="$1"

# ะัะพะฒะตัะบะฐ ัััะตััะฒะพะฒะฐะฝะธั ัะฐะนะปะฐ
if [[ ! -f "$BACKUP_FILE" ]]; then
    error "ะคะฐะนะป ะฑัะบะฐะฟะฐ ะฝะต ะฝะฐะนะดะตะฝ: $BACKUP_FILE"
    exit 1
fi

log "๐ ะะฐัะธะฝะฐะตะผ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต ะธะท: $BACKUP_FILE"

# ะะฟัะตะดะตะปัะตะผ ัะธะฟ ะฑัะบะฐะฟะฐ ะฟะพ ะธะผะตะฝะธ ัะฐะนะปะฐ
if [[ "$BACKUP_FILE" == *"full"* ]]; then
    BACKUP_TYPE="full"
elif [[ "$BACKUP_FILE" == *"data"* ]]; then
    BACKUP_TYPE="data"
elif [[ "$BACKUP_FILE" == *"config"* ]]; then
    BACKUP_TYPE="config"
else
    BACKUP_TYPE="unknown"
fi

log "๐ฆ ะขะธะฟ ะฑัะบะฐะฟะฐ: $BACKUP_TYPE"

# ะะพะดัะฒะตัะถะดะตะฝะธะต ะพั ะฟะพะปัะทะพะฒะฐัะตะปั
warning "โ๏ธ ะะะะะะะะ: ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะฟะตัะตะทะฐะฟะธัะตั ัััะตััะฒัััะธะต ะดะฐะฝะฝัะต!"
read -p "ะัะพะดะพะปะถะธัั? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    log "โ ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะพัะผะตะฝะตะฝะพ"
    exit 0
fi

# ะััะฐะฝะพะฒะบะฐ ะบะพะฝัะตะนะฝะตัะพะฒ ะฟะตัะตะด ะฒะพัััะฐะฝะพะฒะปะตะฝะธะตะผ
log "๐ ะััะฐะฝะพะฒะบะฐ ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker-compose down || true

# ะกะพะทะดะฐะฝะธะต ะฑัะบะฐะฟะฐ ัะตะบััะตะณะพ ัะพััะพัะฝะธั
CURRENT_BACKUP="backups/pre-restore-backup-$(date +%Y%m%d_%H%M%S).tar.gz"
log "๐พ ะกะพะทะดะฐะฝะธะต ะฑัะบะฐะฟะฐ ัะตะบััะตะณะพ ัะพััะพัะฝะธั: $CURRENT_BACKUP"
mkdir -p backups
tar -czf "$CURRENT_BACKUP" data/ 2>/dev/null || true

case $BACKUP_TYPE in
    "full")
        log "๐ฆ ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะฟะพะปะฝะพะณะพ ะฑัะบะฐะฟะฐ..."
        
        # ะกะพะทะดะฐะตะผ ะฒัะตะผะตะฝะฝัั ะดะธัะตะบัะพัะธั
        TEMP_DIR=$(mktemp -d)
        
        # ะะทะฒะปะตะบะฐะตะผ ะฐััะธะฒ ะฒะพ ะฒัะตะผะตะฝะฝัั ะดะธัะตะบัะพัะธั
        tar -xzf "$BACKUP_FILE" -C "$TEMP_DIR"
        
        # ะะพะฟะธััะตะผ ัะฐะนะปั, ะธัะบะปััะฐั ะฝะตะบะพัะพััะต ะดะธัะตะบัะพัะธะธ
        rsync -av --exclude='node_modules' --exclude='.git' --exclude='backups' "$TEMP_DIR/" ./
        
        # ะฃะดะฐะปัะตะผ ะฒัะตะผะตะฝะฝัั ะดะธัะตะบัะพัะธั
        rm -rf "$TEMP_DIR"
        ;;
        
    "data")
        log "๐พ ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะดะฐะฝะฝัั...")
        
        # ะฃะดะฐะปัะตะผ ัััะตััะฒัััะธะต ะดะฐะฝะฝัะต
        rm -rf data/
        
        # ะะทะฒะปะตะบะฐะตะผ ะดะฐะฝะฝัะต ะธะท ะฐััะธะฒะฐ
        tar -xzf "$BACKUP_FILE"
        ;;
        
    "config")
        log "โ๏ธ ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะบะพะฝัะธะณััะฐัะธะธ...")
        
        # ะะทะฒะปะตะบะฐะตะผ ะบะพะฝัะธะณััะฐัะธะพะฝะฝัะต ัะฐะนะปั
        tar -xzf "$BACKUP_FILE"
        ;;
        
    *)
        warning "โ๏ธ ะะตะธะทะฒะตััะฝัะน ัะธะฟ ะฑัะบะฐะฟะฐ, ะฒัะฟะพะปะฝัะตะผ ะฟะพะปะฝะพะต ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต..."
        tar -xzf "$BACKUP_FILE"
        ;;
esac

# ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะฟัะฐะฒ ะดะพัััะฟะฐ
log "๐ง ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะฟัะฐะฒ ะดะพัััะฟะฐ..."
chmod +x scripts/*.sh 2>/dev/null || true

# ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน (ะตัะปะธ ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะปะธ package.json)
if [[ "$BACKUP_TYPE" == "full" || "$BACKUP_TYPE" == "config" ]]; then
    if [[ -f "package.json" ]]; then
        log "๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
        npm install
    fi
fi

# ะะฐะฟััะบ ะบะพะฝัะตะนะฝะตัะพะฒ
log "๐ ะะฐะฟััะบ ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker-compose up -d

# ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ
log "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ ัะตัะฒะธัะพะฒ..."
sleep 15

# ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั
log "๐ฅ ะัะพะฒะตัะบะฐ ัะพััะพัะฝะธั ัะตัะฒะธัะพะฒ..."
for i in {1..30}; do
    if curl -f http://localhost:3000/api/health &>/dev/null; then
        success "โ ะกะตัะฒะธัั ะฒะพัััะฐะฝะพะฒะปะตะฝั ะธ ัะฐะฑะพัะฐัั!"
        break
    fi
    if [[ $i -eq 30 ]]; then
        error "โ ะกะตัะฒะธัั ะฝะต ะพัะฒะตัะฐัั ะฟะพัะปะต ะฒะพัััะฐะฝะพะฒะปะตะฝะธั"
        docker-compose logs
        exit 1
    fi
    sleep 2
done

success "๐ ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะทะฐะฒะตััะตะฝะพ ััะฟะตัะฝะพ!"

# ะะฝัะพัะผะฐัะธั ะพ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะธ
log "๐ ะะฝัะพัะผะฐัะธั ะพ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะธ:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ ะะพัััะฐะฝะพะฒะปะตะฝะพ ะธะท: $BACKUP_FILE"
echo "๐พ ะัะบะฐะฟ ะดะพ ะฒะพัััะฐะฝะพะฒะปะตะฝะธั: $CURRENT_BACKUP"
echo "๐ URL: http://localhost:3000"
echo "๐ ะกัะฐััั: docker-compose ps"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ะะพะบะฐะทะฐัั ััะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ
log "๐ ะกัะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ:"
docker-compose ps